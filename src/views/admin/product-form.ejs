<% 
  // 1. Ki·ªÉm tra xem ƒë√¢y l√† form S·ª≠a hay Th√™m m·ªõi
  const isEditMode = !!product.id;

  // 2. Quy·∫øt ƒë·ªãnh 'action' c·ªßa form (th√™m CSRF token v√†o query string cho multipart form)
  const formAction = isEditMode 
    ? `/admin/products/edit/${product.id}?_csrf=${csrfToken}` 
    : `/admin/products/new?_csrf=${csrfToken}`;
%>

<form action="<%= formAction %>" method="POST" enctype="multipart/form-data" class="admin-form-grid" data-animate="fade-up">
  <input type="hidden" name="_csrf" value="<%= csrfToken %>"/>

  <div class="main-content">
    <div class="admin-card glass-box">
      <div class="form-group">
        <label for="name">T√™n s·∫£n ph·∫©m</label>
        <input type="text" id="name" name="name" 
               value="<%= product.name || '' %>" required>
      </div>

      <div class="form-group">
        <label for="slug">Slug (URL)</label>
        <input type="text" id="slug" name="slug" 
               value="<%= product.slug || '' %>" 
               placeholder="ƒê·ªÉ tr·ªëng ƒë·ªÉ t·ª± ƒë·ªông t·∫°o (khuy√™n d√πng)">
        </div>
      
      <div class="form-group">
        <label for="description_short">M√¥ t·∫£ ng·∫Øn</label>
        <textarea id="description_short" name="description_short" rows="3"><%= product.description_short || '' %></textarea>
      </div>

      <div class="form-group">
        <label for="description">M√¥ t·∫£ chi ti·∫øt</label>
        <textarea id="description" name="description" rows="10"><%= product.description_long || product.description || '' %></textarea>
      </div>
    </div>
  </div>

  <div class="sidebar-content">
    
    <div class="admin-card glass-box">
      <div class="form-group">
        <label for="status">Tr·∫°ng th√°i</label>
        <select id="status" name="status">
          <option value="active" <%= (!product.status || product.status === 'active') ? 'selected' : '' %>>
            üü¢ Ho·∫°t ƒë·ªông (Hi·ªÉn th·ªã)
          </option>
          <option value="draft" <%= (product.status === 'draft') ? 'selected' : '' %>>
            üü° B·∫£n nh√°p (·∫®n)
          </option>
          <option value="archived" <%= (product.status === 'archived') ? 'selected' : '' %>>
            üî¥ L∆∞u tr·ªØ (ƒê√£ x√≥a)
          </option>
        </select>
      </div>

      <button type="submit" class="btn btn-primary w-full">
        <%= isEditMode ? 'C·∫≠p nh·∫≠t s·∫£n ph·∫©m' : 'L∆∞u (Th√™m m·ªõi)' %>
      </button>
      
      <% if (isEditMode) { %>
        <a href="/admin/products" class="btn btn-outline w-full" style="margin-top: 0.5rem;">
          Tr·ªü v·ªÅ danh s√°ch
        </a>
      <% } %>
    </div>

    <div class="admin-card glass-box">
      <div class="form-group">
        <label for="category_id">Danh m·ª•c</label>
        <select id="category_id" name="category_id">
          <option value="">-- Ch·ªçn danh m·ª•c --</option>
          <% (cats || []).forEach(cat => { %>
            <option value="<%= cat.id %>" 
                    <%= (product.category_id == cat.id) ? 'selected' : '' %>>
              <%= cat.name %>
            </option>
          <% }) %>
        </select>
      </div>

      <div class="form-group">
        <label for="price">Gi√° (‚Ç´)</label>
        <input type="number" id="price" name="price" 
               value="<%= product.price || 0 %>" min="0">
      </div>
      
      <div class="form-group">
        <label for="sale_price">Gi√° khuy·∫øn m√£i (‚Ç´)</label>
        <input type="number" id="sale_price" name="sale_price" 
               value="<%= product.sale_price || 0 %>" min="0" 
               placeholder="ƒê·ªÉ 0 n·∫øu kh√¥ng gi·∫£m gi√°">
      </div>

      <div class="form-group">
        <label for="stock_quantity">S·ªë l∆∞·ª£ng kho</label>
        <input type="number" id="stock_quantity" name="stock_quantity" 
               value="<%= product.stock_quantity || 0 %>" min="0">
      </div>
    </div>
    
    <div class="admin-card glass-box">
       <div class="form-group">
        <label for="cover_image_file">üì∑ ·∫¢nh b√¨a (Cover Image)</label>
        <small style="display:block; margin-bottom:0.5rem; color:var(--muted);">
          T·∫£i ·∫£nh t·ª´ m√°y t√≠nh ho·∫∑c nh·∫≠p link ·∫£nh
        </small>
        <input type="file" 
               id="cover_image_file" 
               name="cover_image_file" 
               accept="image/*"
               style="width:100%; padding:0.5rem; border:1px solid var(--border); border-radius:6px; background:var(--bg); color:var(--text); margin-bottom:0.5rem;">
        
        <input type="text" 
               id="cover_image_url" 
               name="cover_image_url" 
               value="<%= product.cover_image_url || '' %>" 
               placeholder="Ho·∫∑c nh·∫≠p link ·∫£nh: https://...">
        <% if (product.cover_image_url) { %>
          <img src="<%= product.cover_image_url %>" class="form-image-preview" alt="Preview">
        <% } %>
      </div>
      
      <div class="form-group">
        <label for="product_images">üñºÔ∏è Th√™m nhi·ªÅu ·∫£nh cho s·∫£n ph·∫©m</label>
        <small style="display:block; margin-bottom:0.5rem; color:var(--muted);">
          Ch·ªçn nhi·ªÅu ·∫£nh t·ª´ m√°y t√≠nh (c√≥ th·ªÉ ch·ªçn nhi·ªÅu file c√πng l√∫c)
        </small>
        <input type="file" 
               id="product_images" 
               name="product_images" 
               accept="image/*" 
               multiple 
               style="width:100%; padding:0.5rem; border:1px solid var(--border); border-radius:6px; background:var(--bg); color:var(--text);">
        
        <!-- Preview ·∫£nh ƒë√£ ch·ªçn -->
        <div id="imagePreview" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(100px, 1fr)); gap:0.5rem; margin-top:1rem;"></div>
        
        <% if (isEditMode && product.images && product.images.length > 0) { %>
        <div style="margin-top:1rem;">
          <strong>·∫¢nh hi·ªán c√≥:</strong>
          <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(100px, 1fr)); gap:0.5rem; margin-top:0.5rem;">
            <% product.images.forEach(img => { %>
              <div style="position:relative;">
                <img src="<%= img.url %>" 
                     style="width:100%; height:100px; object-fit:cover; border-radius:6px; border:1px solid var(--border);"
                     alt="<%= img.alt || '' %>"
                     onerror="this.src='/public/img/placeholder.png'">
              </div>
            <% }) %>
          </div>
        </div>
        <% } %>
      </div>
    </div>

  </div>
</form>


<style>
  .admin-form-grid {
    display: grid;
    grid-template-columns: 1fr 320px; /* C·ªôt tr√°i linh ho·∫°t, c·ªôt ph·∫£i c·ªë ƒë·ªãnh */
    gap: 1.5rem;
  }
  .main-content {
    grid-column: 1 / 2;
  }
  .sidebar-content {
    grid-column: 2 / 3;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .admin-card {
    background: var(--elev);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    padding: 1.5rem;
  }
  .theme-dark .admin-card {
    background: #0f1b33; /* H∆°i kh√°c so v·ªõi layout admin ch√≠nh */
  }

  .form-group {
    margin-bottom: 1.25rem;
  }
  .form-group:last-child {
    margin-bottom: 0;
  }
  .form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.4rem;
    color: var(--text);
  }
  .form-group input[type="text"],
  .form-group input[type="number"],
  .form-group input[type="email"],
  .form-group textarea,
  .form-group select {
    width: 100%;
    padding: 0.6rem 0.8rem;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: var(--bg);
    color: var(--text);
    font-size: 0.95rem;
    transition: all 0.2s ease;
  }
  .form-group input:focus,
  .form-group textarea:focus,
  .form-group select:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-100);
    outline: none;
  }
  .theme-dark .form-group input,
  .theme-dark .form-group textarea,
  .theme-dark .form-group select {
     background: rgba(255,255,255,0.05);
     border-color: #2a3b5c;
  }
  .theme-dark .form-group input:focus,
  .theme-dark .form-group textarea:focus,
  .theme-dark .form-group select:focus {
     box-shadow: 0 0 0 3px #122544;
  }

  .btn.w-full {
    width: 100%;
    justify-content: center;
  }
  
  .form-image-preview {
    width: 100%;
    margin-top: 1rem;
    border-radius: 6px;
    border: 1px solid var(--border);
  }

  /* Responsive */
  @media (max-width: 900px) {
    .admin-form-grid {
      grid-template-columns: 1fr; /* X·∫øp ch·ªìng 2 c·ªôt */
    }
    .main-content {
      grid-row: 2 / 3; /* ƒê·∫©y c·ªôt ch√≠nh xu·ªëng d∆∞·ªõi */
    }
    .sidebar-content {
      grid-row: 1 / 2; 
    }
  }
</style>

<script>
  // Preview ·∫£nh khi ch·ªçn
  document.getElementById('product_images')?.addEventListener('change', function(e) {
    const preview = document.getElementById('imagePreview');
    preview.innerHTML = '';
    
    if (this.files && this.files.length > 0) {
      Array.from(this.files).forEach((file, index) => {
        if (file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.style.cssText = 'width:100%; height:100px; object-fit:cover; border-radius:6px; border:1px solid var(--border);';
            img.alt = file.name;
            preview.appendChild(img);
          };
          reader.readAsDataURL(file);
        }
      });
    }
  });

  // Preview ·∫£nh b√¨a khi ch·ªçn file
  document.getElementById('cover_image_file')?.addEventListener('change', function(e) {
    if (this.files && this.files[0]) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const preview = document.querySelector('.form-image-preview');
        if (preview) {
          preview.src = e.target.result;
        } else {
          const img = document.createElement('img');
          img.src = e.target.result;
          img.className = 'form-image-preview';
          img.style.cssText = 'width:100%; margin-top:1rem; border-radius:6px; border:1px solid var(--border);';
          document.getElementById('cover_image_file').parentNode.appendChild(img);
        }
      };
      reader.readAsDataURL(this.files[0]);
    }
  });
</script>