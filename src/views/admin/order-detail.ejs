<%
  // Helper (Hàm hỗ trợ) để dịch trạng thái
  const translateStatus = (status) => {
    switch(status) {
      case 'new': return 'Mới';
      case 'processing': return 'Đang xử lý';
      case 'shipped': return 'Đã gửi';
      case 'delivered': return 'Đã giao';
      case 'cancelled': return 'Đã hủy';
      default: return status;
    }
  };
%>

<div class="admin-form-grid" data-animate="fade-up">

  <div class="main-content">
    <div class="admin-card glass-box">
      <h4>Các sản phẩm trong đơn</h4>
      
      <div class="table-wrap minimal">
        <table>
          <thead>
            <tr>
              <th colspan="2">Sản phẩm</th>
              <th>Số lượng</th>
              <th>Đơn giá</th>
              <th>Thành tiền</th>
            </tr>
          </thead>
          <tbody>
            <% order.items.forEach(item => { %>
              <tr>
                <td>
                  <img src="<%= item.cover_image_url || '/public/img/placeholder.png' %>" 
                       class="admin-table-thumb" alt="<%= item.product_name %>">
                </td>
                <td>
                  <a href="/p/<%= item.product_slug %>" target="_blank">
                    <%= item.product_name %>
                  </a>
                </td>
                <td>x <%= item.quantity %></td>
                <td><%= item.unit_price.toLocaleString() %>₫</td>
                <td><strong><%= item.total_price.toLocaleString() %>₫</strong></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>

      <div class="order-summary">
        <div class="summary-line">
          <span>Tạm tính:</span>
          <strong><%= order.subtotal.toLocaleString() %>₫</strong>
        </div>
        <div class="summary-line">
          <span>Phí vận chuyển:</span>
          <strong><%= order.shipping_fee.toLocaleString() %>₫</strong>
        </div>
        <% if (order.discount_total > 0) { %>
          <div class="summary-line discount">
            <span>Giảm giá:</span>
            <strong>-<%= order.discount_total.toLocaleString() %>₫</strong>
          </div>
        <% } %>
        <div class="summary-line total">
          <span>Tổng cộng:</span>
          <strong><%= order.grand_total.toLocaleString() %>₫</strong>
        </div>
      </div>

    </div>
  </div>

  <div class="sidebar-content">
    
    <div class="admin-card glass-box">
      <h4>Cập nhật trạng thái</h4>
      <form action="/admin/orders/update-status/<%= order.id %>" method="POST">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>"/>
        <div class="form-group">
          <label for="status">Trạng thái đơn hàng</label>
          <select id="status" name="status">
            <% orderStatuses.forEach(status => { %>
              <option value="<%= status %>" 
                      <%= (status === order.status) ? 'selected' : '' %>>
                <%= translateStatus(status) %>
              </option>
            <% }) %>
          </select>
        </div>
        <button type="submit" class="btn btn-primary w-full">Cập nhật</button>
      </form>
      <a href="/admin/orders" class="btn btn-outline w-full" style="margin-top: 0.5rem;">
        Trở về danh sách
      </a>
    </div>

    <div class="admin-card glass-box">
      <h4>Thông tin khách hàng</h4>
      <div class="info-group">
        <strong><%= order.customer_name || 'Khách vãng lai' %></strong>
        <p><%= order.customer_email || 'Không có email' %></p>
        <p><%= order.customer_phone || (order.shipping_address && order.shipping_address.phone) || 'Không có SĐT' %></p>
      </div>

      <div class="info-group">
        <strong>Địa chỉ giao hàng:</strong>
        <% if (order.shipping_address) { %>
          <p><%= order.shipping_address.full_name %></p>
          <p><%= order.shipping_address.address_line1 %></p>
          <p>
            <%= order.shipping_address.city %>, 
            <%= order.shipping_address.district %>, 
            <%= order.shipping_address.province %>
          </p>
        <% } else { %>
          <p>Không có địa chỉ.</p>
        <% } %>
      </div>
      
      <div class="info-group">
        <strong>Thanh toán:</strong>
        <p>
          <%= (order.payment_method === 'cod') ? 'Thanh toán khi nhận hàng (COD)' : 'Chuyển khoản / Online' %>
        </p>
        <p>
          Trạng thái: 
          <strong><%= (order.payment_status === 'paid') ? 'Đã thanh toán' : 'Chưa thanh toán' %></strong>
        </p>
      </div>
    </div>
  </div>
</div>


<style>
  /* Tái sử dụng layout từ product-form.ejs */
  .admin-form-grid {
    display: grid;
    grid-template-columns: 1fr 320px; 
    gap: 1.5rem;
  }
  .main-content { grid-column: 1 / 2; }
  .sidebar-content {
    grid-column: 2 / 3;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }
  .admin-card {
    background: var(--elev);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    padding: 1.5rem;
  }
  .theme-dark .admin-card { background: #0f1b33; }
  .admin-card h4 {
    font-size: 1.1rem;
    font-weight: 700;
    margin-top: 0;
    margin-bottom: 1rem;
    border-bottom: 1px solid var(--border);
    padding-bottom: 0.5rem;
  }
  
  /* Tái sử dụng style form */
  .form-group { margin-bottom: 1.25rem; }
  .form-group label { display: block; font-weight: 600; margin-bottom: 0.4rem; }
  .form-group select {
    width: 100%;
    padding: 0.6rem 0.8rem;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: var(--bg);
    color: var(--text);
    font-size: 0.95rem;
  }
  .form-group select:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-100);
    outline: none;
  }
  .theme-dark .form-group select { background: rgba(255,255,255,0.05); border-color: #2a3b5c; }
  .theme-dark .form-group select:focus { box-shadow: 0 0 0 3px #122544; }
  .btn.w-full { width: 100%; justify-content: center; }
  
  /* Style cho bảng sản phẩm */
  .table-wrap.minimal {
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
  }
  .table-wrap.minimal table { width: 100%; border-collapse: collapse; }
  .table-wrap.minimal th, .table-wrap.minimal td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid var(--border);
    vertical-align: middle;
  }
  .table-wrap.minimal th { background: var(--primary-100); font-weight: 600; }
  .theme-dark .table-wrap.minimal th { background: #122544; }
  .table-wrap.minimal tbody tr:last-child td { border-bottom: none; }
  .admin-table-thumb {
    width: 45px;
    height: 45px;
    object-fit: cover;
    border-radius: 6px;
    border: 1px solid var(--border);
  }
  .table-wrap.minimal td a { color: var(--text); font-weight: 600; text-decoration: none; }
  .table-wrap.minimal td a:hover { color: var(--primary); }
  
  /* Style cho tổng tiền */
  .order-summary {
    margin-top: 1.5rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border);
    max-width: 400px;
    margin-left: auto; /* Đẩy sang phải */
  }
  .summary-line {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
  }
  .summary-line.discount { color: var(--danger); }
  .summary-line.total {
    font-size: 1.15rem;
    font-weight: 700;
    color: var(--primary-700);
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid var(--border);
  }
  .theme-dark .summary-line.total { color: var(--primary); }
  
  /* Style cho Thông tin khách hàng */
  .info-group {
    margin-bottom: 1rem;
  }
  .info-group p {
    margin: 0.25rem 0;
    color: var(--muted);
  }
  .info-group strong {
    color: var(--text);
  }

  /* Responsive */
  @media (max-width: 900px) {
    .admin-form-grid { grid-template-columns: 1fr; }
    .main-content { grid-row: 2 / 3; }
    .sidebar-content { grid-row: 1 / 2; }
    .order-summary { max-width: 100%; }
  }
</style>